<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .chat-container {
        max-width: 600px;
        margin: 50px auto;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .chat-header {
        background-color: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #ddd;
      }
      .chat-body {
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }
      .chat-footer {
        padding: 10px;
        display: flex;
      }
      .chat-footer input {
        flex: 1;
        margin-right: 10px;
      }
      .chat-message {
        margin-bottom: 10px;
      }
      .chat-bubble {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 5px;
      }
      .chat-bubble.cs {
        background-color: #007bff;
        color: white;
        text-align: right;
      }
      .chat-bubble.client {
        background-color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h5>Customer Support Chat</h5>
      </div>
      <div id="chatBody" class="chat-body">
        <div id="waitingMessage" class="text-center text-muted">
          Menunggu CS menerima chat Anda...
        </div>
      </div>
      <div class="chat-footer">
        <input
          id="messageInput"
          type="text"
          class="form-control"
          placeholder="Type a message..."
          disabled
        />
        <button id="sendBtn" class="btn btn-primary" disabled>Send</button>
      </div>
    </div>

    <script>
      const socket = new WebSocket("ws://localhost:8080");
      const chatBody = document.getElementById("chatBody");
      const waitingMessage = document.getElementById("waitingMessage");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      let typingTimer;

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "register", role: "client" }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "accepted") {
          waitingMessage.remove();
          messageInput.disabled = false;
          sendBtn.disabled = false;
        } else if (data.type === "message") {
          const messageDiv = document.createElement("div");
          messageDiv.className = "chat-bubble client";
          messageDiv.innerText = `CS: ${data.message}`;
          chatBody.appendChild(messageDiv);
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      };

      messageInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault(); // Mencegah pengiriman form jika berada dalam form
          const messageText = messageInput.value;
          if (messageText) {
            socket.send(
              JSON.stringify({
                type: "message",
                message: messageText,
                created: new Date().toLocaleString(),
                timeStamp: new Date().toLocaleTimeString(),
              })
            );
            const messageDiv = document.createElement("div");
            messageDiv.className = "chat-bubble cs";
            messageDiv.innerText = `You: ${messageText}`;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            messageInput.value = "";
          }
        }
      });

      // Send typing notification
      messageInput.addEventListener("input", function () {
        clearTimeout(typingTimer);
        socket.send(JSON.stringify({ type: "typing", typing: true }));
        typingTimer = setTimeout(() => {
          socket.send(JSON.stringify({ type: "typing", typing: false }));
        }, 1000); // Stop typing indicator after 1 second of inactivity
      });

      sendBtn.onclick = () => {
        const messageText = messageInput.value;
        if (messageText) {
          socket.send(
            JSON.stringify({
              type: "message",
              message: messageText,
              created: new Date().toLocaleString(),
              timeStamp: new Date().toLocaleTimeString(),
            })
          );
          const messageDiv = document.createElement("div");
          messageDiv.className = "chat-bubble cs";
          messageDiv.innerText = `You: ${messageText}`;
          chatBody.appendChild(messageDiv);
          chatBody.scrollTop = chatBody.scrollHeight;
          messageInput.value = "";
        }
      };
    </script>
  </body>
</html>
